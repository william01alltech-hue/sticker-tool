<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¶ Sticker Tool v3.6 - å¼·å¤§åˆ‡å‰²ä¿®å¾©ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js"></script>
    <style>
        :root { --line-green: #06c755; --bg: #f2f4f7; --card-bg: #ffffff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #111; }
        .container { max-width: 900px; margin: 0 auto; background: var(--card-bg); border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); padding: 30px; overflow: hidden; }
        
        /* æ¨™é¡Œèˆ‡å°è¦½ */
        header { text-align: center; border-bottom: 2px solid #f0f0f0; padding-bottom: 20px; margin-bottom: 20px; }
        .version-badge { background: #ff4757; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: bold; vertical-align: middle; margin-left: 10px; }

        .nav-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        .nav-item { 
            background: #f8f9fa; border: 2px solid #eee; border-radius: 16px; padding: 20px; text-align: center; cursor: pointer; transition: 0.2s;
        }
        .nav-item:hover, .nav-item.active { border-color: var(--line-green); background: #e8f5e9; transform: translateY(-3px); }
        .nav-item h3 { margin: 10px 0 0 0; font-size: 1rem; color: #333; }
        .nav-icon { font-size: 2rem; display: block; }

        /* å…§å®¹å€å¡Š */
        .section { display: none; animation: slideUp 0.3s ease-out; }
        .section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å…ƒä»¶æ¨£å¼ */
        .upload-zone { 
            border: 3px dashed #d0d0d0; border-radius: 16px; padding: 40px 20px; text-align: center; 
            cursor: pointer; position: relative; background: #fafafa; transition: 0.2s; margin-bottom: 20px;
        }
        .upload-zone:hover { border-color: var(--line-green); background: #fff; }
        .upload-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        
        .control-bar { background: #f1f3f5; padding: 15px; border-radius: 12px; display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px; }
        input[type="number"] { padding: 8px; border-radius: 6px; border: 1px solid #ccc; width: 60px; text-align: center; font-size: 1rem; }
        
        .btn-primary { 
            background: var(--line-green); color: white; border: none; padding: 16px 32px; 
            border-radius: 50px; font-size: 1.1rem; font-weight: bold; cursor: pointer; width: 100%; 
            transition: filter 0.2s; 
        }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }

        /* åˆ‡å‰²ç•«å¸ƒ */
        #crop-wrapper { background: #333; border-radius: 12px; overflow: hidden; margin-bottom: 20px; display: flex; justify-content: center; }
        #crop-canvas { display: block; max-width: 100%; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

        /* å‹•æ…‹æ’­æ”¾å™¨ */
        #player-box { background: #222; border-radius: 16px; padding: 30px; text-align: center; border: 4px solid var(--line-green); margin-bottom: 20px; }
        #player-screen { 
            width: 240px; height: 240px; object-fit: contain; background: #333; border: 2px solid #555; 
            background-image: linear-gradient(45deg, #444 25%, transparent 25%), linear-gradient(-45deg, #444 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #444 75%), linear-gradient(-45deg, transparent 75%, #444 75%);
            background-size: 20px 20px;
        }
        
        #preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px; }
        .thumb { aspect-ratio: 1; background: #eee; border-radius: 6px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .thumb img { max-width: 100%; max-height: 100%; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ¶ Sticker Tool <span class="version-badge">v3.6 åˆ‡å‰²ä¿®å¾©</span></h1>
    </header>

    <div class="nav-grid">
        <div class="nav-item" onclick="switchTab('tab-crop')">
            <span class="nav-icon">âœ‚ï¸</span><h3>1. åœ–é›†åˆ‡å‰²</h3>
        </div>
        <div class="nav-item" onclick="switchTab('tab-anime')">
            <span class="nav-icon">ğŸï¸</span><h3>2. å‹•æ…‹é è¦½</h3>
        </div>
        <div class="nav-item" onclick="switchTab('tab-static')">
            <span class="nav-icon">ğŸ“¦</span><h3>3. æ‰“åŒ…ä¸‹è¼‰</h3>
        </div>
    </div>

    <div id="tab-crop" class="section active">
        <div class="upload-zone">
            <div style="font-size: 3rem;">ğŸ“‚</div>
            <p>é»æ“Šä¸Šå‚³åœ–é›† (å»ºè­° 4x5 æ’åˆ—)</p>
            <input type="file" accept="image/*" onchange="handleCropUpload(this)">
        </div>

        <div class="control-bar">
            <span>æ¬„æ•¸ (ç›´):</span> <input type="number" id="grid-cols" value="4" min="1" onchange="drawGridLine()">
            <span>åˆ—æ•¸ (æ©«):</span> <input type="number" id="grid-rows" value="5" min="1" onchange="drawGridLine()">
            <button onclick="drawGridLine()" style="padding: 8px 15px; cursor:pointer;">åˆ·æ–°ç¶²æ ¼</button>
        </div>

        <div id="crop-wrapper">
            <canvas id="crop-canvas"></canvas>
        </div>

        <button id="btn-cut" class="btn-primary" onclick="startCutting()">ğŸš€ é–‹å§‹åˆ‡å‰² (Execute Crop)</button>
    </div>

    <div id="tab-anime" class="section">
        <div class="control-bar" style="background: #e8f5e9;">
            <label style="cursor:pointer; display:flex; align-items:center; font-weight:bold; color:#2e7d32;">
                <input type="checkbox" id="auto-ai" checked onchange="processAnimationFrames()"> 
                âœ¨ å•Ÿç”¨ AI è‡ªå‹•å»èƒŒ + æé‚Š
            </label>
        </div>

        <div id="player-box">
            <img id="player-screen" src="">
            <div style="color:white; margin-top:15px;">
                æ’­æ”¾é€Ÿåº¦: <input type="range" id="fps-slider" min="1" max="24" value="10" oninput="updateFPS()"> 
                <span id="fps-text">10</span> FPS
            </div>
            <p id="status-msg" style="color:#aaa; font-size:0.9rem;">ç­‰å¾…åœ–ç‰‡...</p>
        </div>

        <button class="btn-primary" style="background:#6c5ce7;" onclick="createAPNG()">ğŸ“¦ ä¸‹è¼‰ APNG (LINE å‹•æ…‹è²¼åœ–)</button>
        
        <div class="upload-zone" style="margin-top:20px; padding:20px;">
            <p>æˆ–æ‰‹å‹•ä¸Šå‚³å¤šå¼µåºåˆ—åœ– (PNG/JPG)</p>
            <input type="file" multiple accept="image/*" onchange="handleAnimeUpload(this.files)">
        </div>
    </div>

    <div id="tab-static" class="section">
        <div id="preview-grid"></div>
        <button class="btn-primary" style="margin-top:20px;" onclick="downloadStaticZip()">ğŸ“¦ ä¸‹è¼‰åºåˆ—åœ– ZIP</button>
    </div>
</div>

<script>
    // å…¨åŸŸè®Šæ•¸
    let rawImage = null;       // åŸå§‹å¤§åœ–
    let rawFrames = [];        // åˆ‡å‰²å¾Œçš„åŸå§‹å°åœ– (Base64)
    let finalFrames = [];      // AI è™•ç†å¾Œçš„æˆå“åœ– (Base64)
    let playTimer = null;      // æ’­æ”¾è¨ˆæ™‚å™¨
    let playIndex = 0;         // ç›®å‰æ’­æ”¾å¹€æ•¸

    // åˆ‡æ›åˆ†é 
    function switchTab(id) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        
        // åªæœ‰åˆ‡æ›åˆ°å‹•æ…‹åˆ†é æ‰æ’­æ”¾
        if(id === 'tab-anime') startPlayer();
        else clearInterval(playTimer);
    }

    // --- 1. åœ–ç‰‡ä¸Šå‚³èˆ‡ç¶²æ ¼ç¹ªè£½ ---
    function handleCropUpload(input) {
        if(!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            rawImage = new Image();
            rawImage.onload = () => {
                const cv = document.getElementById('crop-canvas');
                cv.width = rawImage.width;
                cv.height = rawImage.height;
                drawGridLine();
            };
            rawImage.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }

    function drawGridLine() {
        if(!rawImage) return;
        const cv = document.getElementById('crop-canvas');
        const ctx = cv.getContext('2d');
        
        // é‡ç¹ªåŸåœ–
        ctx.drawImage(rawImage, 0, 0);

        const cols = parseInt(document.getElementById('grid-cols').value);
        const rows = parseInt(document.getElementById('grid-rows').value);
        const cellW = cv.width / cols;
        const cellH = cv.height / rows;

        ctx.strokeStyle = '#00ff00';
        ctx.lineWidth = 3;
        ctx.setLineDash([10, 5]);

        // ç•«å‚ç›´ç·š
        for(let i=1; i<cols; i++) {
            ctx.beginPath(); ctx.moveTo(i*cellW, 0); ctx.lineTo(i*cellW, cv.height); ctx.stroke();
        }
        // ç•«æ°´å¹³ç·š
        for(let j=1; j<rows; j++) {
            ctx.beginPath(); ctx.moveTo(0, j*cellH); ctx.lineTo(cv.width, j*cellH); ctx.stroke();
        }
    }

    // --- 2. æ ¸å¿ƒåˆ‡å‰²é‚è¼¯ (ä¿®å¾©ç‰ˆ) ---
    async function startCutting() {
        if(!rawImage) return alert('è«‹å…ˆä¸Šå‚³åœ–ç‰‡ï¼');
        
        const btn = document.getElementById('btn-cut');
        btn.innerText = 'â³ æ­£åœ¨åˆ‡å‰²è™•ç†ä¸­...';
        btn.disabled = true;

        // çµ¦ UI ä¸€é»æ™‚é–“æ›´æ–°æ–‡å­—
        await new Promise(r => setTimeout(r, 50));

        try {
            const cols = parseInt(document.getElementById('grid-cols').value);
            const rows = parseInt(document.getElementById('grid-rows').value);
            
            // ä½¿ç”¨ floor é¿å…æµ®é»æ•¸èª¤å·®å°è‡´çš„ç©ºç™½
            const cellW = Math.floor(rawImage.width / cols);
            const cellH = Math.floor(rawImage.height / rows);

            rawFrames = [];
            
            // æš«å­˜ç•«å¸ƒ
            const tempCv = document.createElement('canvas');
            const tempCtx = tempCv.getContext('2d');
            tempCv.width = cellW;
            tempCv.height = cellH;

            for(let r=0; r<rows; r++) {
                for(let c=0; c<cols; c++) {
                    // æ¸…ç©ºæš«å­˜
                    tempCtx.clearRect(0, 0, cellW, cellH);
                    // æ ¸å¿ƒåˆ‡å‰²ï¼šå¾åŸåœ–æ“·å–å€å¡Š
                    tempCtx.drawImage(
                        rawImage, 
                        c * cellW, r * cellH, cellW, cellH,  // ä¾†æºåº§æ¨™èˆ‡å¤§å°
                        0, 0, cellW, cellH                   // ç›®æ¨™åº§æ¨™èˆ‡å¤§å°
                    );
                    rawFrames.push(tempCv.toDataURL('image/png'));
                }
            }

            console.log(`åˆ‡å‰²å®Œæˆï¼šå…± ${rawFrames.length} å¼µ`);
            
            // è‡ªå‹•è·³è½‰ä¸¦è™•ç†
            switchTab('tab-anime');
            await processAnimationFrames();
            
        } catch (err) {
            alert('åˆ‡å‰²å¤±æ•—ï¼š' + err.message);
            console.error(err);
        } finally {
            btn.innerText = 'ğŸš€ é–‹å§‹åˆ‡å‰² (Execute Crop)';
            btn.disabled = false;
        }
    }

    // --- 3. AI è™•ç†èˆ‡æ’­æ”¾ ---
    function handleAnimeUpload(files) {
        rawFrames = [];
        let loaded = 0;
        Array.from(files).forEach((f, i) => {
            const r = new FileReader();
            r.onload = (e) => {
                rawFrames[i] = e.target.result; // ä¿æŒé †åº
                loaded++;
                if(loaded === files.length) processAnimationFrames();
            };
            r.readAsDataURL(f);
        });
        switchTab('tab-anime');
    }

    async function processAnimationFrames() {
        const status = document.getElementById('status-msg');
        status.innerText = 'æ­£åœ¨é€²è¡Œ AI å»èƒŒèˆ‡æé‚Š...';
        clearInterval(playTimer);

        const useAI = document.getElementById('auto-ai').checked;
        finalFrames = [];

        for(let src of rawFrames) {
            if(useAI) {
                finalFrames.push(await applyAI(src));
            } else {
                finalFrames.push(src);
            }
        }

        status.innerText = `å·²è¼‰å…¥ ${finalFrames.length} å¼µå½±æ ¼`;
        updateStaticWall();
        startPlayer();
    }

    // AI å»èƒŒå‡½æ•¸
    function applyAI(src) {
        return new Promise(resolve => {
            const img = new Image();
            img.onload = () => {
                const pad = 10;
                const cv = document.createElement('canvas');
                cv.width = img.width + pad*2; cv.height = img.height + pad*2;
                const ctx = cv.getContext('2d');
                ctx.drawImage(img, pad, pad);

                // å»èƒŒ (æ¿¾é™¤ç™½è‰²)
                const id = ctx.getImageData(0,0,cv.width,cv.height);
                const d = id.data;
                for(let i=0; i<d.length; i+=4) {
                    if(d[i]>230 && d[i+1]>230 && d[i+2]>230) d[i+3] = 0;
                }
                ctx.putImageData(id, 0, 0);

                // æé‚Š
                const sc = document.createElement('canvas');
                sc.width = cv.width; sc.height = cv.height;
                const sctx = sc.getContext('2d');
                sctx.shadowColor = 'white'; sctx.shadowBlur = 4;
                sctx.drawImage(cv, 0, 0);
                sctx.drawImage(cv, 0, 0); // ç•«å…©æ¬¡å¢å¼·
                sctx.shadowBlur = 0;
                sctx.drawImage(cv, 0, 0); // è“‹ä¸ŠåŸåœ–

                resolve(sc.toDataURL());
            };
            img.src = src;
        });
    }

    // æ’­æ”¾å™¨é‚è¼¯
    function startPlayer() {
        clearInterval(playTimer);
        if(finalFrames.length === 0) return;
        
        const fps = document.getElementById('fps-slider').value;
        playTimer = setInterval(() => {
            document.getElementById('player-screen').src = finalFrames[playIndex];
            playIndex = (playIndex + 1) % finalFrames.length;
        }, 1000 / fps);
    }

    function updateFPS() {
        document.getElementById('fps-text').innerText = document.getElementById('fps-slider').value;
        startPlayer();
    }

    // --- 4. è¼¸å‡ºåŠŸèƒ½ ---
    async function createAPNG() {
        if(finalFrames.length === 0) return alert('æ²’æœ‰åœ–ç‰‡');
        const fps = document.getElementById('fps-slider').value;
        const delay = 1000 / fps;
        
        const buffs = [];
        const w = 320; // LINE æ¨™æº–å¯¬
        const h = 270; // LINE æ¨™æº–é«˜ (ç¤ºæ„)
        // é€™è£¡æˆ‘å€‘ç”¨ç¬¬ä¸€å¼µåœ–çš„å¯¦éš›å°ºå¯¸
        const tempImg = new Image();
        await new Promise(r => { tempImg.onload = r; tempImg.src = finalFrames[0]; });
        
        const cv = document.createElement('canvas');
        cv.width = tempImg.width; cv.height = tempImg.height;
        const ctx = cv.getContext('2d');

        for(let src of finalFrames) {
            await new Promise(r => {
                const img = new Image();
                img.onload = () => {
                    ctx.clearRect(0,0,cv.width,cv.height);
                    ctx.drawImage(img, 0, 0);
                    buffs.push(ctx.getImageData(0,0,cv.width,cv.height).data.buffer);
                    r();
                };
                img.src = src;
            });
        }

        const blob = UPNG.encode(buffs, cv.width, cv.height, 0, new Array(finalFrames.length).fill(delay));
        const link = document.createElement('a');
        link.download = 'sticker_animation.png';
        link.href = URL.createObjectURL(new Blob([blob], {type:'image/png'}));
        link.click();
    }

    function updateStaticWall() {
        const grid = document.getElementById('preview-grid');
        grid.innerHTML = '';
        finalFrames.forEach(src => {
            const div = document.createElement('div');
            div.className = 'thumb';
            div.innerHTML = `<img src="${src}">`;
            grid.appendChild(div);
        });
    }

    function downloadStaticZip() {
        if(finalFrames.length === 0) return alert('æ²’æœ‰åœ–ç‰‡');
        const zip = new JSZip();
        finalFrames.forEach((src, i) => zip.file(`${i+1}.png`, src.split(',')[1], {base64: true}));
        zip.generateAsync({type:"blob"}).then(b => {
            const a = document.createElement('a'); a.download = 'frames.zip'; a.href = URL.createObjectURL(b); a.click();
        });
    }
</script>
</body>
</html>
