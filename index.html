<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¶ ç„¡æ¯›ç‹—è²¼åœ–æ——è‰¦ç¥å™¨ - AI ç‰ˆ 2.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --primary-color: #00c300; --bg-dark: #222; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; max-width: 900px; width: 100%; }
        .upload-area { border: 2px dashed #ccc; padding: 30px; border-radius: 15px; cursor: pointer; background: #fafafa; position: relative; margin-bottom: 20px; transition: 0.3s; }
        .upload-area:hover { border-color: var(--primary-color); background: #f0fff0; }
        .upload-area input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        
        /* é è¦½ç‰†ï¼šå–æ¶ˆé«˜åº¦é™åˆ¶ï¼ŒèƒŒæ™¯ç‚ºå°ˆæ¥­æ£‹ç›¤æ ¼ */
        #preview-wall { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); 
            gap: 15px; margin: 20px 0; padding: 20px; background: var(--bg-dark); border-radius: 12px; min-height: 100px;
        }
        .preview-item { 
            aspect-ratio: 1; background-color: #333; cursor: zoom-in; border-radius: 8px; display: flex; align-items: center; justify-content: center;
            background-image: linear-gradient(45deg, #444 25%, transparent 25%), linear-gradient(-45deg, #444 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #444 75%), linear-gradient(-45deg, transparent 75%, #444 75%);
            background-size: 20px 20px; background-position: 0 0, 0 10px, 10px 10px, 10px 0; transition: 0.2s;
        }
        .preview-item:hover { transform: scale(1.05); border: 2px solid var(--primary-color); }
        .preview-item img { max-width: 90%; max-height: 90%; object-fit: contain; }

        /* ç‡ˆç®±è¦–çª— */
        #lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; cursor: pointer; flex-direction: column; }
        #lightbox img { max-width: 80%; max-height: 80%; border: 2px solid white; background: #333; }
        #lightbox-close { color: white; font-size: 20px; margin-bottom: 10px; }

        /* é€²åº¦æ¢èˆ‡æŒ‰éˆ• */
        #progress-container { display: none; margin: 25px 0; padding: 20px; background: #fff; border: 1px solid #eee; border-radius: 12px; text-align: left; }
        .progress-track { width: 100%; background: #eee; height: 12px; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        #progress-bar { width: 0%; background: var(--primary-color); height: 100%; transition: width 0.2s; }
        .btn-main { background: var(--primary-color); color: white; border: none; padding: 18px 35px; font-size: 1.2rem; font-weight: bold; border-radius: 50px; cursor: pointer; width: 100%; box-shadow: 0 4px 15px rgba(0,195,0,0.3); }
        .btn-main:disabled { background: #ccc; cursor: not-allowed; }
        code { background: #eee; padding: 2px 5px; cursor: pointer; border-radius: 4px; color: #d32f2f; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ¶ Sticker Tool AI æ——è‰¦ç‰ˆ</h1>
    <p>å…¨é è¦½ + é»æ“Šæ”¾å¤§ + è‡ªå‹•å»èƒŒæé‚Š</p>

    <div class="upload-area">
        <input type="file" id="upload" accept="image/png, image/jpeg" multiple onchange="handleFiles()">
        <div style="font-size: 2.5rem;">ğŸ“¸</div>
        <p id="file-status">é»æ“Šæˆ–æ‹–æ›³ 40 å¼µåœ–é€²ä¾†ï¼Œæª¢æŸ¥å»èƒŒå“è³ª</p>
    </div>

    <div id="preview-wall"></div>

    <div id="progress-container">
        <div style="display:flex; justify-content:space-between; font-weight:bold;">
            <span id="status-text">ğŸš€ æ‰“åŒ…é€²è¡Œä¸­...</span>
            <span id="progress-percent">0%</span>
        </div>
        <div class="progress-track"><div id="progress-bar"></div></div>
        <div id="remaining-time" style="font-size:0.85rem; color:#666;">é è¨ˆå‰©é¤˜æ™‚é–“ï¼šè¨ˆç®—ä¸­...</div>
    </div>

    <div style="margin: 20px 0; font-weight: 500;">
        <label><input type="checkbox" id="removeBg" checked onchange="handleFiles()"> AI å»èƒŒ</label> &nbsp;
        <label><input type="checkbox" id="addStroke" checked onchange="handleFiles()"> è‡ªå‹•åŠ ç™½é‚Š</label>
    </div>

    <button id="btn-zip" class="btn-main" onclick="processAll()">ğŸš€ ç¢ºèªå“è³ªï¼Œä¸€éµæ‰“åŒ…ä¸‹è¼‰ ZIP</button>

    <div style="text-align: left; margin-top: 25px; padding: 15px; background: #f8f9fa; border-radius: 10px; font-size: 0.85em;">
        <b>ğŸ“Œ å¾Œå°è³‡è¨Š (é»æ“Šè¤‡è£½)ï¼š</b><br>
        æ¨™é¡Œï¼š<code onclick="copyText('Learning Hairless Dog')">Learning Hairless Dog</code> | 
        èªªæ˜ï¼š<code onclick="copyText('Follow the cute hairless dog!')">Follow the cute hairless dog!</code>
    </div>
</div>

<div id="lightbox" onclick="this.style.display='none'">
    <div id="lightbox-close">âœ– é»æ“Šä»»æ„è™•é—œé–‰</div>
    <img id="lightbox-img" src="">
</div>

<script>
    let currentFiles = [];

    function copyText(txt) { navigator.clipboard.writeText(txt); alert('å·²è¤‡è£½'); }

    async function handleFiles() {
        const input = document.getElementById('upload');
        if (input.files.length > 0) currentFiles = Array.from(input.files);
        if (currentFiles.length === 0) return;

        document.getElementById('file-status').innerText = `æ­£åœ¨ç”¢å‡º ${currentFiles.length} å¼µåœ–çš„é è¦½...`;
        const wall = document.getElementById('preview-wall');
        wall.innerHTML = ''; 

        for (let i = 0; i < currentFiles.length; i++) {
            const dataUrl = await generateProcessedDataUrl(currentFiles[i], 300, 300);
            const div = document.createElement('div');
            div.className = 'preview-item';
            div.onclick = () => { document.getElementById('lightbox-img').src = dataUrl; document.getElementById('lightbox').style.display = 'flex'; };
            div.innerHTML = `<img src="${dataUrl}">`;
            wall.appendChild(div);
        }
        document.getElementById('file-status').innerText = `âœ… é è¦½å®Œæˆï¼Œé»æ“Šå¯æ”¾å¤§æª¢æŸ¥ç´°ç¯€`;
    }

    async function generateProcessedDataUrl(file, targetW, targetH) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const tCanvas = document.createElement('canvas');
                    const tCtx = tCanvas.getContext('2d');
                    const offset = 10;
                    tCanvas.width = img.width + offset * 2;
                    tCanvas.height = img.height + offset * 2;
                    tCtx.drawImage(img, offset, offset);

                    if (document.getElementById('removeBg').checked) {
                        const imgData = tCtx.getImageData(0, 0, tCanvas.width, tCanvas.height);
                        const d = imgData.data;
                        const r = d[0], g = d[1], b = d[2];
                        for (let j = 0; j < d.length; j += 4) {
                            if (Math.abs(d[j]-r)<35 && Math.abs(d[j+1]-g)<35 && Math.abs(d[j+2]-b)<35) d[j+3]=0;
                        }
                        tCtx.putImageData(imgData, 0, 0);
                    }

                    if (document.getElementById('addStroke').checked) {
                        const sCanvas = document.createElement('canvas');
                        sCanvas.width = tCanvas.width; sCanvas.height = tCanvas.height;
                        const sCtx = sCanvas.getContext('2d');
                        sCtx.shadowColor = 'white'; sCtx.shadowBlur = 1;
                        for(let x=-2; x<=2; x++) for(let y=-2; y<=2; y++) sCtx.drawImage(tCanvas, x, y);
                        sCtx.drawImage(tCanvas, 0, 0);
                        tCtx.clearRect(0,0,tCanvas.width, tCanvas.height);
                        tCtx.drawImage(sCanvas, 0, 0);
                    }

                    const outCanvas = document.createElement('canvas');
                    const outCtx = outCanvas.getContext('2d');
                    outCanvas.width = targetW; outCanvas.height = targetH;
                    const scale = Math.min((targetW-24)/tCanvas.width, (targetH-24)/tCanvas.height);
                    outCtx.drawImage(tCanvas, (targetW-tCanvas.width*scale)/2, (targetH-tCanvas.height*scale)/2, tCanvas.width*scale, tCanvas.height*scale);
                    resolve(outCanvas.toDataURL("image/png"));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    async function processAll() {
        if (currentFiles.length === 0) return alert('è«‹å…ˆé¸å–åœ–ç‰‡ï¼');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const remainingText = document.getElementById('remaining-time');
        const btn = document.getElementById('btn-zip');
        
        btn.disabled = true;
        progressContainer.style.display = 'block';

        const zip = new JSZip();
        const startTime = Date.now();
        const specs = [
            { w: 240, h: 240, folder: 'main', prefix: 'main' },
            { w: 96, h: 74, folder: 'tab', prefix: 'tab' },
            { w: 370, h: 320, folder: 'stickers', prefix: '' }
        ];

        for (let i = 0; i < currentFiles.length; i++) {
            for (const spec of specs) {
                const dataUrl = await generateProcessedDataUrl(currentFiles[i], spec.w, spec.h);
                const blob = await (await fetch(dataUrl)).blob();
                const idx = (i + 1).toString().padStart(2, '0');
                zip.file(`${spec.folder}/${spec.prefix ? spec.prefix : idx}.png`, blob);
            }
            const current = i + 1;
            const percent = Math.round((current / currentFiles.length) * 100);
            const elapsed = (Date.now() - startTime) / 1000;
            const estimate = Math.round((elapsed / current) * (currentFiles.length - current));
            progressBar.style.width = percent + '%';
            document.getElementById('progress-percent').innerText = percent + '%';
            remainingText.innerText = `é è¨ˆå‰©é¤˜æ™‚é–“ï¼š${estimate} ç§’ (å·²å®Œæˆ ${current}/${currentFiles.length})`;
        }

        const content = await zip.generateAsync({type: "blob"});
        const link = document.createElement('a');
        link.download = `ç„¡æ¯›ç‹—è²¼åœ–_å…¨èƒ½æ——è‰¦ç‰ˆ.zip`;
        link.href = URL.createObjectURL(content);
        link.click();
        
        btn.disabled = false;
        remainingText.innerText = "âœ… å…¨éƒ¨æ‰“åŒ…ä¸‹è¼‰å®Œæˆï¼";
    }
</script>
</body>
</html>