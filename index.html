<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ğŸ¶ Sticker Tool 3.2 - å°ˆæ¥­ä¸‰åˆä¸€ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --line-green: #00c300; --bg: #f8f9fa; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; }
        .app-container { max-width: 1000px; margin: 40px auto; background: white; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); overflow: hidden; }
        
        /* é¦–é åˆ†æµ UI */
        #page-home { padding: 60px 40px; text-align: center; }
        .menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 40px; }
        .menu-card { background: white; border: 2px solid #eee; padding: 40px 15px; border-radius: 20px; cursor: pointer; transition: 0.3s; }
        .menu-card:hover { border-color: var(--line-green); transform: translateY(-8px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .menu-card .icon { font-size: 3.5rem; margin-bottom: 15px; }
        .menu-card h2 { font-size: 1.25rem; margin: 0; color: #333; }

        /* é€šç”¨é é¢æ¨£å¼ */
        .page { display: none; padding: 30px; animation: fadeIn 0.4s; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .nav-bar { display: flex; align-items: center; padding: 15px 30px; border-bottom: 1px solid #eee; background: #fff; }
        .back-btn { background: #f0f0f0; border: none; padding: 8px 18px; border-radius: 8px; cursor: pointer; font-weight: bold; }

        /* å‹•æ…‹æ’­æ”¾å™¨ */
        #anime-box { background: #222; border-radius: 15px; padding: 40px; margin: 20px 0; text-align: center; }
        #anime-img { width: 240px; height: 240px; object-fit: contain; background: #333; border: 2px solid #555; }
        
        /* é è¦½ç‰†èˆ‡åˆ‡å‰² */
        #preview-wall { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; background: #222; padding: 15px; border-radius: 12px; margin-top: 20px; }
        .preview-item { aspect-ratio: 1; background: #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .preview-item img { max-width: 90%; }
        #crop-canvas { background: #333; max-width: 100%; border: 2px solid #444; margin-top: 15px; cursor: crosshair; }

        .btn-action { background: var(--line-green); color: white; border: none; padding: 16px; border-radius: 50px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 15px; font-size: 1.1rem; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="page-home" class="page active">
        <div style="font-size: 5rem;">ğŸ¶</div>
        <h1 style="margin: 10px 0;">Sticker Tool 3.2</h1>
        <p style="color: #888;">å°ˆæ¥­è²¼åœ–é–‹ç™¼é¡§å•ç³»çµ± - 2026 æ——è‰¦ç‰ˆ</p>
        
        <div class="menu-grid">
            <div class="menu-card" onclick="switchPage('page-static')">
                <div class="icon">âœ¨</div>
                <h2>AI è‡ªå‹•è™•ç†</h2>
            </div>
            <div class="menu-card" onclick="switchPage('page-anime')">
                <div class="icon">ğŸï¸</div>
                <h2>å‹•æ…‹æ’­æ”¾å™¨</h2>
            </div>
            <div class="menu-card" onclick="switchPage('page-crop')">
                <div class="icon">âœ‚ï¸</div>
                <h2>åœ–é›†ç¶²æ ¼åˆ‡å‰²</h2>
            </div>
        </div>
    </div>

    <div id="page-static" class="page">
        <nav class="nav-bar"><button class="back-btn" onclick="switchPage('page-home')">â† è¿”å›</button><h2 style="margin-left:20px;">AI è‡ªå‹•è™•ç†</h2></nav>
        <div style="margin-top:20px; border:3px dashed #eee; padding:40px; border-radius:20px; text-align:center; position:relative;">
            <input type="file" multiple accept="image/*" onchange="handleStaticFiles(this.files)" style="position:absolute; inset:0; opacity:0; cursor:pointer;">
            <p id="static-status">ğŸ“¥ æ‹–æ›³å¤§é‡åŸåœ–é€²ä¾† (è‡ªå‹•å»èƒŒæé‚Š)</p>
        </div>
        <div id="preview-wall"></div>
        <button class="btn-action" onclick="downloadZip()">ğŸš€ æ‰“åŒ…ä¸‹è¼‰å…¨å¥— ZIP</button>
    </div>

    <div id="page-anime" class="page">
        <nav class="nav-bar"><button class="back-btn" onclick="switchPage('page-home')">â† è¿”å›</button><h2 style="margin-left:20px;">å‹•æ…‹æ’­æ”¾æ¸¬è©¦</h2></nav>
        <div style="margin-top:20px; border:2px dashed #ccc; padding:20px; border-radius:15px; text-align:center;">
            <input type="file" id="anime-upload" multiple accept="image/*" onchange="loadAnimeFiles(this.files)">
            <p>è«‹ä¸Šå‚³ 5~20 å¼µåºåˆ—åœ–</p>
        </div>
        <div id="anime-box">
            <img id="anime-img" src="">
            <div style="color:white; margin-top:20px;">
                æ’­æ”¾é€Ÿåº¦ (FPS): <input type="range" id="fps-range" min="1" max="24" value="12" oninput="updateSpeed()"> <span id="fps-val">12</span>
            </div>
        </div>
    </div>

    <div id="page-crop" class="page">
        <nav class="nav-bar"><button class="back-btn" onclick="switchPage('page-home')">â† è¿”å›</button><h2 style="margin-left:20px;">åœ–é›†åˆ‡å‰²æ¨¡å¼</h2></nav>
        <div style="background:#f4f4f4; padding:20px; border-radius:12px; margin-bottom:15px; text-align:left;">
            <strong>1. ä¸Šå‚³åœ–é›†ï¼š</strong> <input type="file" accept="image/*" onchange="loadCropImage(this)"><br><br>
            <strong>2. è¨­å®šç¶²æ ¼ï¼š</strong> æ¬„ <input type="number" id="grid-cols" value="4" style="width:50px; padding:5px;"> åˆ— <input type="number" id="grid-rows" value="5" style="width:50px; padding:5px;">
            <button style="margin-left:10px; padding:5px 15px;" onclick="drawGrid()">æ›´æ–°ç¶²æ ¼</button>
        </div>
        <canvas id="crop-canvas"></canvas>
        <button class="btn-action" onclick="startAutoCrop()">ğŸš€ åŸ·è¡Œä¸€éµåˆ‡å‰²ä¸¦é€²è¡Œ AI è™•ç†</button>
    </div>
</div>

<script>
    let currentImgs = [];
    let rawCropImg = null;
    let animeTimer = null;
    let animeIdx = 0;

    function switchPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if (id !== 'page-anime') clearInterval(animeTimer);
    }

    // --- å‹•æ…‹é è¦½åŠŸèƒ½ ---
    function loadAnimeFiles(files) {
        currentImgs = [];
        const fileArr = Array.from(files);
        fileArr.forEach((f, idx) => {
            const r = new FileReader();
            r.onload = (e) => { 
                currentImgs[idx] = e.target.result; 
                if(currentImgs.filter(n => n).length === fileArr.length) startPlay(); 
            };
            r.readAsDataURL(f);
        });
    }

    function startPlay() {
        clearInterval(animeTimer);
        const fps = document.getElementById('fps-range').value;
        animeTimer = setInterval(() => {
            if (currentImgs.length === 0) return;
            document.getElementById('anime-img').src = currentImgs[animeIdx];
            animeIdx = (animeIdx + 1) % currentImgs.length;
        }, 1000 / fps);
    }

    function updateSpeed() {
        document.getElementById('fps-val').innerText = document.getElementById('fps-range').value;
        startPlay();
    }

    // --- åˆ‡å‰²åŠŸèƒ½ ---
    function loadCropImage(i) {
        const r = new FileReader(); 
        r.onload=(e)=>{
            rawCropImg=new Image(); 
            rawCropImg.onload=()=>{
                const cv = document.getElementById('crop-canvas'); 
                cv.width=rawCropImg.width; cv.height=rawCropImg.height; 
                drawGrid();
            }; 
            rawCropImg.src=e.target.result;
        }; 
        r.readAsDataURL(i.files[0]);
    }

    function drawGrid() {
        const cv = document.getElementById('crop-canvas'); const ctx = cv.getContext('2d');
        ctx.drawImage(rawCropImg, 0, 0);
        const c = document.getElementById('grid-cols').value, r = document.getElementById('grid-rows').value;
        const w = cv.width/c, h = cv.height/r;
        ctx.strokeStyle='#00c300'; ctx.lineWidth=3; ctx.setLineDash([15, 5]);
        for(let i=1; i<c; i++){ ctx.beginPath(); ctx.moveTo(i*w,0); ctx.lineTo(i*w,cv.height); ctx.stroke(); }
        for(let j=1; j<r; j++){ ctx.beginPath(); ctx.moveTo(0,j*h); ctx.lineTo(cv.width,j*h); ctx.stroke(); }
    }

    async function startAutoCrop() {
        const c = document.getElementById('grid-cols').value, r = document.getElementById('grid-rows').value;
        const w = rawCropImg.width/c, h = rawCropImg.height/r;
        const blobs = []; const tc = document.createElement('canvas'); const tctx = tc.getContext('2d');
        tc.width=w; tc.height=h;
        for(let i=0; i<r; i++) for(let j=0; j<c; j++){
            tctx.clearRect(0,0,w,h); tctx.drawImage(rawCropImg, j*w, i*h, w, h, 0, 0, w, h);
            blobs.push(await new Promise(res => tc.toBlob(res)));
        }
        handleStaticFiles(blobs); switchPage('page-static');
    }

    // --- AI è™•ç†é‚è¼¯ ---
    async function handleStaticFiles(files) {
        const wall = document.getElementById('preview-wall'); wall.innerHTML = 'æ­£åœ¨ AI è™•ç†ä¸­...';
        currentImgs = [];
        for (let i = 0; i < files.length; i++) {
            const src = await aiProcess(files[i]);
            currentImgs.push(src);
            const div = document.createElement('div'); div.className = 'preview-item';
            div.innerHTML = `<img src="${src}">`;
            if (i === 0) wall.innerHTML = ''; 
            wall.appendChild(div);
        }
        document.getElementById('static-status').innerText = `âœ… å·²è‡ªå‹•è™•ç† ${files.length} å¼µåœ–`;
    }

    async function aiProcess(file) {
        return new Promise((res) => {
            const r = new FileReader();
            r.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                    const off = 15; c.width = img.width+off*2; c.height = img.height+off*2;
                    ctx.drawImage(img, off, off);
                    const id = ctx.getImageData(0,0,c.width,c.height); const d = id.data;
                    const r0=d[0], g0=d[1], b0=d[2];
                    for(let i=0; i<d.length; i+=4) if(Math.abs(d[i]-r0)<35 && Math.abs(d[i+1]-g0)<35 && Math.abs(d[i+2]-b0)<35) d[i+3]=0;
                    ctx.putImageData(id,0,0);
                    const sc = document.createElement('canvas'); sc.width=c.width; sc.height=c.height;
                    const sctx = sc.getContext('2d'); sctx.shadowColor='white'; sctx.shadowBlur=1;
                    for(let x=-2; x<=2; x++) for(let y=-2; y<=2; y++) sctx.drawImage(c,x,y);
                    sctx.drawImage(c,0,0); res(sc.toDataURL());
                };
                img.src = e.target.result;
            };
            r.readAsDataURL(file instanceof Blob ? file : new Blob([file]));
        });
    }

    function downloadZip() {
        const zip = new JSZip();
        currentImgs.forEach((src, i) => zip.file(`sticker_${(i+1).toString().padStart(2,'0')}.png`, src.split(',')[1], {base64: true}));
        zip.generateAsync({type:"blob"}).then(b => { 
            const l=document.createElement('a'); l.download="StickerTool_Final.zip"; l.href=URL.createObjectURL(b); l.click(); 
        });
    }
</script>
</body>
</html>
