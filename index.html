<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¶ Sticker Tool v3.8 - å¼·é…¸å»èƒŒç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js"></script>
    <style>
        :root { --main: #00c300; --bg: #f0f2f5; --danger: #ff4757; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 950px; margin: 0 auto; background: white; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); padding: 40px; }
        
        header { text-align: center; border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 30px; }
        .badge { background: var(--danger); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; vertical-align: middle; }

        /* å°è¦½æŒ‰éˆ• */
        .nav-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .nav-btn { 
            background: #fff; border: 2px solid #e0e0e0; border-radius: 16px; padding: 25px; text-align: center; cursor: pointer; transition: 0.2s; 
        }
        .nav-btn:hover, .nav-btn.active { border-color: var(--main); background: #e8f5e9; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .nav-icon { font-size: 2.5rem; display: block; margin-bottom: 10px; }

        /* å€å¡Šé¡¯ç¤ºæ§åˆ¶ */
        .section { display: none; animation: slideUp 0.3s; }
        .section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ä¸Šå‚³å€ */
        .upload-zone { 
            border: 3px dashed #ccc; padding: 50px; text-align: center; border-radius: 16px; 
            cursor: pointer; position: relative; background: #fafafa; transition: 0.3s;
        }
        .upload-zone:hover { border-color: var(--main); background: #fff; }
        .upload-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

        /* æ§åˆ¶åˆ— */
        .control-bar { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 12px; align-items: center; }
        input[type="number"] { width: 60px; padding: 8px; text-align: center; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem; }
        
        /* ç•«å¸ƒèˆ‡é è¦½ */
        #crop-wrapper { background: #333; padding: 10px; border-radius: 12px; text-align: center; overflow: auto; margin-bottom: 20px; }
        #crop-canvas { max-width: 100%; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        
        #anime-box { 
            background: #222; border-radius: 16px; padding: 30px; margin: 20px 0; text-align: center; 
            border: 4px solid var(--main); 
        }
        #anime-screen { 
            width: 240px; height: 240px; object-fit: contain; background: #333; border: 2px solid #555;
            /* å¼·åˆ¶é¡¯ç¤ºæ£‹ç›¤æ ¼èƒŒæ™¯ï¼Œè®“ä½ ç¢ºèªæ˜¯å¦é€æ˜ */
            background-image: linear-gradient(45deg, #444 25%, transparent 25%), linear-gradient(-45deg, #444 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #444 75%), linear-gradient(-45deg, transparent 75%, #444 75%);
            background-size: 20px 20px;
        }

        .btn-main { 
            background: var(--main); color: white; border: none; padding: 16px 32px; 
            border-radius: 50px; font-size: 1.1rem; font-weight: bold; cursor: pointer; width: 100%; 
            transition: 0.2s;
        }
        .btn-main:hover { filter: brightness(1.1); }
        
        .thumb-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .thumb { background: #eee; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; aspect-ratio: 1; border: 1px solid #ddd; }
        .thumb img { width: 100%; height: 100%; object-fit: contain; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ¶ Sticker Tool <span class="badge">v3.8 å¼·é…¸å»èƒŒ</span></h1>
        <p>å¼·åŠ›æ¸…é™¤ç°è‰²æ£‹ç›¤æ ¼èƒŒæ™¯ï¼Œåªä¿ç•™æ€ªç¸æœ¬é«”ï¼</p>
    </header>

    <div class="nav-grid">
        <div class="nav-btn" onclick="switchTab('tab-crop')"><span class="nav-icon">âœ‚ï¸</span><h3>1. åœ–é›†åˆ‡å‰²</h3></div>
        <div class="nav-btn" onclick="switchTab('tab-anime')"><span class="nav-icon">ğŸï¸</span><h3>2. å‹•æ…‹é è¦½</h3></div>
        <div class="nav-btn" onclick="switchTab('tab-static')"><span class="nav-icon">âœ¨</span><h3>3. éœæ…‹åˆ—è¡¨</h3></div>
    </div>

    <div id="tab-crop" class="section active">
        <div class="upload-zone">
            <div style="font-size: 3rem;">ğŸ“‚</div>
            <p>ä¸Šå‚³ä½ çš„è—è‰²å°æ€ªç¸ (å«æ£‹ç›¤æ ¼)</p>
            <input type="file" accept="image/*" onchange="loadCropImage(this)">
        </div>
        <div class="control-bar">
            <span>æ¬„æ•¸ (Cols):</span> <input type="number" id="cols" value="4">
            <span>åˆ—æ•¸ (Rows):</span> <input type="number" id="rows" value="5">
            <button onclick="drawGrid()" style="cursor:pointer; padding: 8px 20px; border-radius: 20px; border: 1px solid #ccc;">æ›´æ–°ç¶²æ ¼</button>
        </div>
        <div id="crop-wrapper"><canvas id="crop-canvas"></canvas></div>
        <button id="cut-btn" class="btn-main" onclick="startCutAndProcess()">ğŸš€ åŸ·è¡Œï¼šå¼·åŠ›å»èƒŒåˆ‡å‰²</button>
    </div>

    <div id="tab-anime" class="section">
        <div id="anime-box">
            <img id="anime-screen" src="">
            <div style="color:white; margin-top:15px;">
                æ’­æ”¾é€Ÿåº¦: <input type="range" id="fps" min="1" max="24" value="10" oninput="updateFPS()"> <span id="fps-val">10</span> FPS
            </div>
            <p id="status-text" style="color:#aaa; font-size:0.9rem;">è«‹å…ˆåŸ·è¡Œåˆ‡å‰²</p>
        </div>
        <button class="btn-main" style="background:#6c5ce7;" onclick="createAPNG()">ğŸ“¦ ä¸‹è¼‰é€æ˜ APNG (LINE å‹•æ…‹è²¼åœ–)</button>
        <div class="upload-zone" style="margin-top:20px; padding:20px;">
            <p>æˆ–æ‰‹å‹•ä¸Šå‚³åºåˆ—åœ–</p>
            <input type="file" multiple accept="image/*" onchange="loadAnimeFiles(this.files)">
        </div>
    </div>

    <div id="tab-static" class="section">
        <div id="preview-wall" class="thumb-grid"></div>
        <button class="btn-main" style="margin-top:20px;" onclick="downloadZip()">ğŸ“¦ ä¸‹è¼‰æ‰€æœ‰å–®åœ– ZIP</button>
    </div>
</div>

<script>
    let rawImg = null;
    let frames = [];
    let timer = null;
    let frameIdx = 0;

    function switchTab(id) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id !== 'tab-anime') clearInterval(timer);
    }

    // --- 1. è¼‰å…¥èˆ‡åˆ‡å‰² ---
    function loadCropImage(input) {
        if(!input.files[0]) return;
        const r = new FileReader();
        r.onload = (e) => {
            rawImg = new Image();
            rawImg.onload = () => {
                const cv = document.getElementById('crop-canvas');
                cv.width = rawImg.width; cv.height = rawImg.height;
                drawGrid();
            };
            rawImg.src = e.target.result;
        };
        r.readAsDataURL(input.files[0]);
    }

    function drawGrid() {
        if(!rawImg) return;
        const cv = document.getElementById('crop-canvas'); const ctx = cv.getContext('2d');
        ctx.drawImage(rawImg, 0, 0);
        const c = parseInt(document.getElementById('cols').value);
        const r = parseInt(document.getElementById('rows').value);
        const w = cv.width/c; const h = cv.height/r;
        ctx.strokeStyle = '#00ff00'; ctx.lineWidth = 3; ctx.setLineDash([10, 5]);
        for(let i=1; i<c; i++){ ctx.beginPath(); ctx.moveTo(i*w,0); ctx.lineTo(i*w,cv.height); ctx.stroke(); }
        for(let j=1; j<r; j++){ ctx.beginPath(); ctx.moveTo(0,j*h); ctx.lineTo(cv.width,j*h); ctx.stroke(); }
    }

    async function startCutAndProcess() {
        if(!rawImg) return alert('è«‹å…ˆä¸Šå‚³åœ–ç‰‡');
        const btn = document.getElementById('cut-btn');
        btn.innerText = 'â³ æ­£åœ¨å¼·åŠ›å»èƒŒä¸­ (Edge Erosion)...';
        btn.disabled = true;

        await new Promise(r => setTimeout(r, 50)); // UI æ›´æ–°å»¶é²

        const c = parseInt(document.getElementById('cols').value);
        const r = parseInt(document.getElementById('rows').value);
        const w = Math.floor(rawImg.width / c);
        const h = Math.floor(rawImg.height / r);
        
        frames = [];
        const cv = document.createElement('canvas'); 
        cv.width = w; cv.height = h;
        const ctx = cv.getContext('2d');

        for(let i=0; i<r; i++) {
            for(let j=0; j<c; j++) {
                // 1. åˆ‡å‰²å–®å¼µ
                ctx.clearRect(0,0,w,h);
                ctx.drawImage(rawImg, j*w, i*h, w, h, 0, 0, w, h);
                
                // 2. åŸ·è¡Œã€Œé‚Šç·£ä¾µè•å»èƒŒã€(è§£æ±ºç°è‰²æ£‹ç›¤æ ¼)
                aggressiveFloodFill(ctx, w, h);

                // 3. åŠ ä¸Šç™½è‰²æé‚Š
                const strokedUrl = addStroke(cv);
                frames.push(strokedUrl);
            }
        }
        
        btn.innerText = 'ğŸš€ åŸ·è¡Œï¼šå¼·åŠ›å»èƒŒåˆ‡å‰²';
        btn.disabled = false;
        
        updateStaticWall();
        switchTab('tab-anime');
        startPlay();
    }

    // --- æ ¸å¿ƒæ¼”ç®—æ³•ï¼šé‚Šç·£ä¾µè•å»èƒŒ (Aggressive Flood Fill) ---
    function aggressiveFloodFill(ctx, w, h) {
        const imgData = ctx.getImageData(0, 0, w, h);
        const d = imgData.data;
        const visited = new Uint8Array(w * h);
        
        // å¾åœ–ç‰‡å››å€‹é‚Šçš„æ‰€æœ‰åƒç´ é–‹å§‹é€²æ”»
        const queue = [];
        for(let x=0; x<w; x++) { queue.push([x, 0]); queue.push([x, h-1]); }
        for(let y=0; y<h; y++) { queue.push([0, y]); queue.push([w-1, y]); }

        // åˆ¤æ–·æ˜¯å¦ç‚ºã€Œå¯åˆªé™¤çš„èƒŒæ™¯è‰²ã€
        // åªè¦æ˜¯ã€Œäº®è‰²ç³»ã€æˆ–ã€Œç°è‰²ç³»ã€éƒ½æ®ºç„¡èµ¦ï¼Œç›´åˆ°é‡åˆ°ã€Œå½©è‰²/æ·±è‰²ã€é‚Šæ¡†
        function isErasable(r, g, b) {
            // æ¢ä»¶1: å¤ äº® (å¯èƒ½æ˜¯ç™½è‰²æˆ–æ·ºç°)
            const isBright = (r > 180 && g > 180 && b > 180);
            // æ¢ä»¶2: å¤ ä¸­æ€§ (R,G,B æ•¸å€¼æ¥è¿‘ï¼Œä»£è¡¨æ˜¯ç°éš)
            const isNeutral = (Math.abs(r-g) < 25 && Math.abs(g-b) < 25 && Math.abs(r-b) < 25);
            return isBright && isNeutral;
        }

        while(queue.length > 0) {
            const [x, y] = queue.pop();
            const idx = (y * w + x);
            
            if(x < 0 || x >= w || y < 0 || y >= h || visited[idx]) continue;
            
            visited[idx] = 1; // æ¨™è¨˜å·²æª¢æŸ¥
            const pos = idx * 4;
            const r = d[pos], g = d[pos+1], b = d[pos+2];

            if (isErasable(r, g, b)) {
                // æ˜¯èƒŒæ™¯ï¼åˆªé™¤ï¼
                d[pos+3] = 0; 
                
                // ç¹¼çºŒå¾€é„°å±…æ“´æ•£
                queue.push([x+1, y], [x-1, y], [x, y+1], [x, y-1]);
            }
        }
        
        ctx.putImageData(imgData, 0, 0);
    }

    function addStroke(sourceCanvas) {
        const w = sourceCanvas.width;
        const h = sourceCanvas.height;
        const sc = document.createElement('canvas');
        sc.width = w; sc.height = h;
        const sctx = sc.getContext('2d');
        
        // ç¹ªè£½ç™½è‰²æé‚Š
        sctx.shadowColor = 'white';
        sctx.shadowBlur = 4;
        sctx.drawImage(sourceCanvas, 0, 0);
        sctx.drawImage(sourceCanvas, 0, 0);
        
        // è“‹ä¸ŠåŸåœ–
        sctx.shadowBlur = 0;
        sctx.drawImage(sourceCanvas, 0, 0);
        
        return sc.toDataURL();
    }

    // --- æ’­æ”¾èˆ‡è¼¸å‡º ---
    function loadAnimeFiles(files) {
        frames = [];
        let loaded = 0;
        Array.from(files).forEach((f, i) => {
            const r = new FileReader();
            r.onload = (e) => {
                frames[i] = e.target.result; loaded++;
                if(loaded === files.length) startPlay();
            };
            r.readAsDataURL(f);
        });
        switchTab('tab-anime');
    }

    function startPlay() {
        clearInterval(timer);
        if(frames.length === 0) return;
        document.getElementById('status-text').innerText = `è¼‰å…¥æˆåŠŸ`;
        const fps = document.getElementById('fps').value;
        timer = setInterval(() => {
            document.getElementById('anime-screen').src = frames[frameIdx];
            frameIdx = (frameIdx + 1) % frames.length;
        }, 1000 / fps);
    }

    function updateFPS() {
        document.getElementById('fps-val').innerText = document.getElementById('fps').value;
        startPlay();
    }

    async function createAPNG() {
        if(frames.length === 0) return alert('æ²’æœ‰åœ–ç‰‡');
        const fps = document.getElementById('fps').value;
        const delay = 1000 / fps;
        
        const buffs = [];
        const img = new Image();
        await new Promise(r => { img.onload = r; img.src = frames[0]; });
        const w = img.width, h = img.height;
        const cv = document.createElement('canvas'); cv.width=w; cv.height=h;
        const ctx = cv.getContext('2d');

        for(let src of frames) {
            await new Promise(r => {
                const i = new Image(); i.onload = () => {
                    ctx.clearRect(0,0,w,h); ctx.drawImage(i,0,0);
                    buffs.push(ctx.getImageData(0,0,w,h).data.buffer); r();
                }; i.src = src;
            });
        }
        
        const blob = UPNG.encode(buffs, w, h, 0, new Array(frames.length).fill(delay));
        const link = document.createElement('a'); link.download = 'sticker_transparent.png';
        link.href = URL.createObjectURL(new Blob([blob], {type:'image/png'})); link.click();
    }

    function updateStaticWall() {
        const wall = document.getElementById('preview-wall'); wall.innerHTML = '';
        frames.forEach(src => {
            const d = document.createElement('div'); d.className = 'thumb';
            // é€™è£¡ç‰¹æ„åŠ ä¸ŠèƒŒæ™¯åœ–ï¼Œè®“ä½ ä¸€çœ¼çœ‹å‡ºæ˜¯å¦é€æ˜
            d.style.backgroundImage = 'linear-gradient(45deg, #ddd 25%, transparent 25%), linear-gradient(-45deg, #ddd 25%, transparent 25%)';
            d.style.backgroundSize = '10px 10px';
            d.innerHTML = `<img src="${src}">`; wall.appendChild(d);
        });
    }

    function downloadZip() {
        const zip = new JSZip();
        frames.forEach((src, i) => zip.file(`${i+1}.png`, src.split(',')[1], {base64:true}));
        zip.generateAsync({type:"blob"}).then(b=>{
            const a=document.createElement('a'); a.download='frames.zip'; a.href=URL.createObjectURL(b); a.click();
        });
    }
</script>
</body>
</html>
