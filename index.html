<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ğŸ¶ Sticker Tool 3.0 - å°ˆæ¥­åˆ†æµæ——è‰¦ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --line-green: #00c300; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 0; }
        .app-container { max-width: 1000px; margin: 40px auto; background: white; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); overflow: hidden; }
        
        /* é¦–é åˆ†æµ UI */
        #page-home { padding: 60px 40px; text-align: center; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 40px; }
        .menu-card { background: white; border: 2px solid #eee; padding: 50px 30px; border-radius: 20px; cursor: pointer; transition: 0.3s; }
        .menu-card:hover { border-color: var(--line-green); transform: translateY(-10px); }
        .menu-card .icon { font-size: 4rem; margin-bottom: 20px; }

        /* é€šç”¨å…ƒä»¶ */
        .page { display: none; padding: 30px; }
        .active { display: block; }
        .nav-bar { display: flex; align-items: center; padding: 20px 30px; border-bottom: 1px solid #eee; }
        .back-btn { background: #f0f0f0; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; }

        /* åˆ‡å‰²èˆ‡é è¦½ */
        .crop-layout { display: grid; grid-template-columns: 250px 1fr; gap: 20px; }
        .sidebar { background: #f9f9f9; padding: 20px; border-radius: 15px; text-align: left; }
        #crop-canvas { background: #333; cursor: crosshair; max-width: 100%; border: 2px solid #555; }
        #preview-wall { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; background: #222; padding: 20px; border-radius: 15px; }
        .preview-item { aspect-ratio: 1; background: #333; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: zoom-in; }
        .preview-item img { max-width: 90%; max-height: 90%; }
        
        .btn-action { background: var(--line-green); color: white; border: none; padding: 15px 30px; border-radius: 50px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px; }
        #lightbox { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="page-home" class="page active">
        <div style="font-size: 5rem;">ğŸ¾</div>
        <h1>Sticker Tool 3.0</h1>
        <div class="menu-grid">
            <div class="menu-card" onclick="switchPage('page-static')">
                <div class="icon">âœ¨</div>
                <h2>å…¨è‡ªå‹• AI è™•ç†</h2>
                <p>å¤§é‡åœ–ç‰‡å»èƒŒã€åŠ ç™½é‚Š</p>
            </div>
            <div class="menu-card" onclick="switchPage('page-crop')">
                <div class="icon">âœ‚ï¸</div>
                <h2>åœ–é›†ç¶²æ ¼åˆ‡å‰²</h2>
                <p>è‡ªå‹•åˆ‡åˆ†å‹•æ…‹åºåˆ—åœ–</p>
            </div>
        </div>
    </div>

    <div id="page-static" class="page">
        <nav class="nav-bar"><button class="back-btn" onclick="switchPage('page-home')">â† è¿”å›</button><h2 style="margin-left: 20px;">AI è‡ªå‹•è™•ç†</h2></nav>
        <div style="margin-top:20px; border:3px dashed #eee; padding:40px; border-radius:20px; position:relative;">
            <input type="file" id="upload" multiple accept="image/*" onchange="handleStaticFiles(this.files)" style="position:absolute; inset:0; opacity:0;">
            <p id="static-status">é»æ“Šæˆ–æ‹–æ›³åŸåœ–é€²ä¾†</p>
        </div>
        <div id="preview-wall"></div>
        <button class="btn-action" onclick="downloadZip()">ğŸš€ æ‰“åŒ…ä¸‹è¼‰å…¨å¥— ZIP</button>
    </div>

    <div id="page-crop" class="page">
        <nav class="nav-bar"><button class="back-btn" onclick="switchPage('page-home')">â† è¿”å›</button><h2 style="margin-left: 20px;">åœ–é›†åˆ‡å‰²æ¨¡å¼</h2></nav>
        <div class="crop-layout">
            <div class="sidebar">
                <p><strong>1. ä¸Šå‚³åœ–é›†</strong></p><input type="file" accept="image/*" onchange="loadCropImage(this)">
                <p><strong>2. è¨­å®šç¶²æ ¼</strong></p>
                æ¬„æ•¸: <input type="number" id="grid-cols" value="4" oninput="drawGrid()">
                åˆ—æ•¸: <input type="number" id="grid-rows" value="5" oninput="drawGrid()">
                <button class="btn-action" onclick="startAutoCrop()">ğŸš€ åŸ·è¡Œåˆ‡å‰²ä¸¦è™•ç†</button>
            </div>
            <canvas id="crop-canvas"></canvas>
        </div>
    </div>
</div>

<div id="lightbox" onclick="this.style.display='none'"><img id="lb-img" src=""></div>

<script>
    let currentProcessedFiles = [];
    let rawCropImg = null;
    const cropCanvas = document.getElementById('crop-canvas');
    const ctx = cropCanvas.getContext('2d');

    function switchPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function loadCropImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                rawCropImg = new Image();
                rawCropImg.onload = () => { cropCanvas.width = rawCropImg.width; cropCanvas.height = rawCropImg.height; drawGrid(); };
                rawCropImg.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function drawGrid() {
        if (!rawCropImg) return;
        ctx.drawImage(rawCropImg, 0, 0);
        const cols = document.getElementById('grid-cols').value;
        const rows = document.getElementById('grid-rows').value;
        const w = cropCanvas.width / cols; const h = cropCanvas.height / rows;
        ctx.strokeStyle = '#00c300'; ctx.lineWidth = 2; ctx.setLineDash([10, 5]);
        for (let i = 1; i < cols; i++) { ctx.beginPath(); ctx.moveTo(i*w, 0); ctx.lineTo(i*w, cropCanvas.height); ctx.stroke(); }
        for (let j = 1; j < rows; j++) { ctx.beginPath(); ctx.moveTo(0, j*h); ctx.lineTo(cropCanvas.width, j*h); ctx.stroke(); }
    }

    async function startAutoCrop() {
        if (!rawCropImg) return alert("è«‹å…ˆä¸Šå‚³åœ–ç‰‡ï¼");
        const cols = document.getElementById('grid-cols').value;
        const rows = document.getElementById('grid-rows').value;
        const w = rawCropImg.width / cols; const h = rawCropImg.height / rows;
        const blobs = []; const tempCanvas = document.createElement('canvas'); const tCtx = tempCanvas.getContext('2d');
        tempCanvas.width = w; tempCanvas.height = h;

        for (let r = 0; r < rows; r++) {
            for (let c = 0; c < cols; c++) {
                tCtx.clearRect(0,0,w,h); tCtx.drawImage(rawCropImg, c*w, r*h, w, h, 0, 0, w, h);
                const blob = await new Promise(res => tempCanvas.toBlob(res, 'image/png'));
                blobs.push(blob);
            }
        }
        handleStaticFiles(blobs);
        switchPage('page-static');
    }

    async function handleStaticFiles(files) {
        const wall = document.getElementById('preview-wall'); wall.innerHTML = 'æ­£åœ¨è™•ç†ä¸­...';
        currentProcessedFiles = [];
        for (let i = 0; i < files.length; i++) {
            const dataUrl = await aiProcess(files[i]); currentProcessedFiles.push(dataUrl);
        }
        wall.innerHTML = '';
        currentProcessedFiles.forEach(src => {
            const div = document.createElement('div'); div.className = 'preview-item';
            div.onclick = () => { document.getElementById('lb-img').src = src; document.getElementById('lightbox').style.display = 'flex'; };
            div.innerHTML = `<img src="${src}">`; wall.appendChild(div);
        });
        document.getElementById('static-status').innerText = `âœ… å·²è™•ç† ${files.length} å¼µ`;
    }

    async function aiProcess(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    const offset = 15; canvas.width = img.width + offset * 2; canvas.height = img.height + offset * 2;
                    ctx.drawImage(img, offset, offset);
                    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height); const d = imgData.data;
                    const r = d[0], g = d[1], b = d[2];
                    for (let j = 0; j < d.length; j += 4) { if (Math.abs(d[j]-r)<35 && Math.abs(d[j+1]-g)<35 && Math.abs(d[j+2]-b)<35) d[j+3]=0; }
                    ctx.putImageData(imgData, 0, 0);
                    const sCanvas = document.createElement('canvas'); sCanvas.width = canvas.width; sCanvas.height = canvas.height;
                    const sCtx = sCanvas.getContext('2d'); sCtx.shadowColor = 'white'; sCtx.shadowBlur = 1;
                    for(let x=-2; x<=2; x++) for(let y=-2; y<=2; y++) sCtx.drawImage(canvas, x, y);
                    sCtx.drawImage(canvas, 0, 0);
                    resolve(sCanvas.toDataURL("image/png"));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file instanceof Blob ? file : new Blob([file]));
        });
    }

    async function downloadZip() {
        if (currentProcessedFiles.length === 0) return alert("è«‹å…ˆè™•ç†åœ–ç‰‡ï¼");
        const zip = new JSZip();
        for (let i = 0; i < currentProcessedFiles.length; i++) {
            const blob = await (await fetch(currentProcessedFiles[i])).blob();
            zip.file(`sticker_${(i+1).toString().padStart(2, '0')}.png`, blob);
        }
        zip.generateAsync({type: "blob"}).then(c => {
            const l = document.createElement('a'); l.download = `Pack_3.0.zip`; l.href = URL.createObjectURL(c); l.click();
        });
    }
</script>
</body>
</html>
