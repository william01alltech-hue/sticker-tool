(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const t of i)if(t.type==="childList")for(const o of t.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function n(i){const t={};return i.integrity&&(t.integrity=i.integrity),i.referrerPolicy&&(t.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?t.credentials="include":i.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function a(i){if(i.ep)return;i.ep=!0;const t=n(i);fetch(i.href,t)}})();class L{constructor(e,n){this.canvas=document.getElementById(e),this.ctx=this.canvas.getContext("2d"),this.image=n,this.cols=4,this.rows=2,this.vLines=[],this.hLines=[],this.dragMode=null,this.dragIndex=-1,this.isDragging=!1,this.initCanvas(),this.resetGrid(this.cols,this.rows),this.addEventListeners()}initCanvas(){this.canvas.width=this.image.width,this.canvas.height=this.image.height,this.canvas.style.width="100%",this.canvas.style.height="auto",this.draw()}resetGrid(e,n){this.vLines=[],this.hLines=[];const a=this.canvas.width/e,i=this.canvas.height/n;for(let t=1;t<e;t++)this.vLines.push(t*a);for(let t=1;t<n;t++)this.hLines.push(t*i);this.draw()}draw(){const{ctx:e,canvas:n,image:a,vLines:i,hLines:t}=this;e.clearRect(0,0,n.width,n.height),e.drawImage(a,0,0),e.fillStyle="rgba(0, 0, 0, 0.3)",e.fillRect(0,0,n.width,n.height),e.beginPath(),e.strokeStyle="#00FF00",e.lineWidth=Math.max(2,n.width/200),i.forEach(o=>{e.moveTo(o,0),e.lineTo(o,n.height)}),t.forEach(o=>{e.moveTo(0,o),e.lineTo(n.width,o)}),e.stroke()}drawDebugDot(e,n,a="red"){this.draw(),this.ctx.beginPath(),this.ctx.arc(e,n,20,0,Math.PI*2),this.ctx.fillStyle=a,this.ctx.fill(),this.ctx.fillStyle="white",this.ctx.font="30px Arial",this.ctx.fillText(`X:${Math.round(e)}`,e+30,n)}getHitLine(e,n,a){const i=40*a;for(let t=0;t<this.vLines.length;t++)if(Math.abs(e-this.vLines[t])<i)return{type:"v",index:t};for(let t=0;t<this.hLines.length;t++)if(Math.abs(n-this.hLines[t])<i)return{type:"h",index:t};return null}addEventListeners(){const e=t=>{const o=this.canvas.getBoundingClientRect();let r,l;t.touches&&t.touches.length>0?(r=t.touches[0].clientX,l=t.touches[0].clientY):(r=t.clientX,l=t.clientY);const c=this.canvas.width/o.width,d=this.canvas.height/o.height;return{x:(r-o.left)*c,y:(l-o.top)*d,scaleX:c}},n=t=>{t.cancelable&&t.preventDefault();const{x:o,y:r,scaleX:l}=e(t);this.drawDebugDot(o,r,"red");const c=this.getHitLine(o,r,l);c&&(this.isDragging=!0,this.dragMode=c.type,this.dragIndex=c.index,this.drawDebugDot(o,r,"yellow"))},a=t=>{if(t.cancelable&&t.preventDefault(),this.isDragging){const{x:o,y:r}=e(t);this.dragMode==="v"?this.vLines[this.dragIndex]=Math.max(0,Math.min(this.canvas.width,o)):this.hLines[this.dragIndex]=Math.max(0,Math.min(this.canvas.height,r)),this.draw(),this.drawDebugDot(o,r,"blue")}},i=()=>{this.isDragging=!1,this.dragIndex=-1,this.draw()};this.canvas.addEventListener("mousedown",n),this.canvas.addEventListener("mousemove",a),window.addEventListener("mouseup",i),this.canvas.addEventListener("touchstart",n,{passive:!1}),this.canvas.addEventListener("touchmove",a,{passive:!1}),window.addEventListener("touchend",i)}async executeCut(){const e=[],n=[0,...this.vLines,this.canvas.width].sort((i,t)=>i-t),a=[0,...this.hLines,this.canvas.height].sort((i,t)=>i-t);for(let i=0;i<a.length-1;i++)for(let t=0;t<n.length-1;t++){const o=n[t+1]-n[t],r=a[i+1]-a[i],l=document.createElement("canvas");l.width=o,l.height=r,l.getContext("2d").drawImage(this.image,n[t],a[i],o,r,0,0,o,r),e.push(l.toDataURL("image/png"))}return e}}let m=null,h=[],v=null,f=0,w=null;document.getElementById("file-uploader").addEventListener("change",E);document.getElementById("btn-reset-grid").addEventListener("click",p);document.getElementById("cut-btn").addEventListener("click",I);window.switchTab=function(s){document.querySelectorAll(".section").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".nav-btn").forEach(e=>e.classList.remove("active")),document.getElementById(s).classList.add("active"),s==="tab-crop"&&document.getElementById("btn-tab-crop").classList.add("active"),s==="tab-anime"&&document.getElementById("btn-tab-anime").classList.add("active"),s==="tab-static"&&document.getElementById("btn-tab-static").classList.add("active"),s!=="tab-anime"&&clearInterval(v)};function E(s){const e=s.target.files[0];if(!e)return;const n=new FileReader;n.onload=a=>{const i=new Image;i.onload=()=>{m=new L("crop-canvas",i),p()},i.src=a.target.result},n.readAsDataURL(e)}function p(){if(!m)return;const s=parseInt(document.getElementById("cols").value)||4,e=parseInt(document.getElementById("rows").value)||5;m.resetGrid(s,e)}async function I(){if(!m)return alert("請先上傳圖片");window.showLoading("切割 + 魔術棒去背處理中..."),await new Promise(s=>setTimeout(s,100));try{const s=await m.executeCut();h=[];for(let e=0;e<s.length;e++){const n=await b(s[e]);h.push(n)}window.updateStaticWall(),window.switchTab("tab-anime"),window.startPlay()}catch(s){console.error(s),alert("處理失敗: "+s)}finally{window.hideLoading()}}async function b(s){return new Promise(e=>{const n=new Image;n.onload=()=>{const a=n.width,i=n.height,t=document.createElement("canvas");t.width=a,t.height=i;const o=t.getContext("2d");o.drawImage(n,0,0),x(o,a,i);const r=B(t);e(r)},n.src=s})}function x(s,e,n){const a=s.getImageData(0,0,e,n),i=a.data,t=new Uint8Array(e*n),o=[],r=[[0,0],[e-1,0],[0,n-1],[e-1,n-1]];for(let c=0;c<e;c+=5)r.push([c,0]);for(let c=0;c<n;c+=5)r.push([0,c]);r.forEach(c=>o.push(c));function l(c,d,g){if(c>240&&d>240&&g>240)return!0;const u=Math.abs(c-d)<15&&Math.abs(d-g)<15&&Math.abs(c-g)<15,y=c>180&&c<240;return u&&y}for(;o.length>0;){const[c,d]=o.pop(),g=d*e+c;if(c<0||c>=e||d<0||d>=n||t[g])continue;t[g]=1;const u=g*4;l(i[u],i[u+1],i[u+2])&&(i[u+3]=0,o.push([c+1,d],[c-1,d],[c,d+1],[c,d-1]))}s.putImageData(a,0,0)}function B(s){const e=s.width,n=s.height,a=document.createElement("canvas");a.width=e,a.height=n;const i=a.getContext("2d");return i.shadowColor="white",i.shadowBlur=4,i.drawImage(s,0,0),i.drawImage(s,0,0),i.shadowBlur=0,i.drawImage(s,0,0),a.toDataURL()}window.showLoading=s=>{document.getElementById("loading-text").innerText=s,document.getElementById("loading-overlay").style.display="flex"};window.hideLoading=()=>{document.getElementById("loading-overlay").style.display="none"};window.createAPNG=async function(){if(h.length===0)return alert("沒有圖片");window.showLoading("生成 APNG 中..."),await new Promise(s=>setTimeout(s,100));try{const e=1e3/document.getElementById("fps").value,n=[],a=new Image;await new Promise(d=>{a.onload=d,a.src=h[0]});const i=a.width,t=a.height,o=document.createElement("canvas");o.width=i,o.height=t;const r=o.getContext("2d");for(let d=0;d<h.length;d++)await new Promise(g=>{const u=new Image;u.onload=()=>{r.clearRect(0,0,i,t),r.drawImage(u,0,0),n.push(r.getImageData(0,0,i,t).data.buffer),g()},u.src=h[d]});const l=UPNG.encode(n,i,t,0,new Array(h.length).fill(e));w=new Blob([l],{type:"image/png"});const c=URL.createObjectURL(w);document.getElementById("result-img").src=c,document.getElementById("result-area").style.display="block",document.getElementById("result-area").scrollIntoView({behavior:"smooth"})}catch(s){alert("生成失敗: "+s),console.error(s)}finally{window.hideLoading()}};window.downloadResultBlob=function(){if(!w)return;const s=document.createElement("a");s.download="sticker_animation.png",s.href=URL.createObjectURL(w),s.click()};window.loadAnimeFiles=function(s){h=[];let e=0;Array.from(s).forEach((n,a)=>{const i=new FileReader;i.onload=t=>{h[a]=t.target.result,e++,e===s.length&&window.startPlay()},i.readAsDataURL(n)}),window.switchTab("tab-anime")};window.startPlay=function(){if(clearInterval(v),h.length===0)return;document.getElementById("status-text").innerText="準備就緒";const s=document.getElementById("fps").value;v=setInterval(()=>{document.getElementById("anime-screen").src=h[f],f=(f+1)%h.length},1e3/s)};window.updateFPS=function(){document.getElementById("fps-val").innerText=document.getElementById("fps").value,window.startPlay()};window.updateStaticWall=function(){const s=document.getElementById("preview-wall");s.innerHTML="",h.forEach(e=>{const n=document.createElement("div");n.className="thumb",n.innerHTML=`<img src="${e}">`,s.appendChild(n)})};window.downloadZip=function(){const s=new JSZip;h.forEach((e,n)=>s.file(`${n+1}.png`,e.split(",")[1],{base64:!0})),s.generateAsync({type:"blob"}).then(e=>{const n=document.createElement("a");n.download="frames.zip",n.href=URL.createObjectURL(e),n.click()})};
