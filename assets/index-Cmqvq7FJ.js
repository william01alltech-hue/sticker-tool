(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const e of n)if(e.type==="childList")for(const a of e.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function s(n){const e={};return n.integrity&&(e.integrity=n.integrity),n.referrerPolicy&&(e.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?e.credentials="include":n.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function o(n){if(n.ep)return;n.ep=!0;const e=s(n);fetch(n.href,e)}})();class L{constructor(t,s){this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.image=s,this.cols=4,this.rows=2,this.vLines=[],this.hLines=[],this.dragMode=null,this.dragIndex=-1,this.isDragging=!1,this.initCanvas(),this.resetGrid(this.cols,this.rows),this.addEventListeners()}initCanvas(){this.canvas.width=this.image.width,this.canvas.height=this.image.height,this.draw()}resetGrid(t,s){this.vLines=[],this.hLines=[];const o=this.canvas.width/t,n=this.canvas.height/s;for(let e=1;e<t;e++)this.vLines.push(e*o);for(let e=1;e<s;e++)this.hLines.push(e*n);this.draw()}draw(){const{ctx:t,canvas:s,image:o,vLines:n,hLines:e}=this;t.clearRect(0,0,s.width,s.height),t.drawImage(o,0,0),t.fillStyle="rgba(0, 0, 0, 0.3)",t.fillRect(0,0,s.width,s.height),t.beginPath(),t.strokeStyle="#00FF00",t.lineWidth=4,n.forEach(a=>{t.moveTo(a,0),t.lineTo(a,s.height)}),e.forEach(a=>{t.moveTo(0,a),t.lineTo(s.width,a)}),t.stroke()}getHitLine(t,s,o,n){const e=30*o,a=30*n;for(let c=0;c<this.vLines.length;c++)if(Math.abs(t-this.vLines[c])<e)return{type:"v",index:c};for(let c=0;c<this.hLines.length;c++)if(Math.abs(s-this.hLines[c])<a)return{type:"h",index:c};return null}addEventListeners(){const t=e=>{const a=this.canvas.getBoundingClientRect();let c,l;e.touches&&e.touches.length>0?(c=e.touches[0].clientX,l=e.touches[0].clientY):(c=e.clientX,l=e.clientY);const r=this.canvas.width/a.width,d=this.canvas.height/a.height;return{x:(c-a.left)*r,y:(l-a.top)*d,scaleX:r,scaleY:d}},s=e=>{e.cancelable&&e.preventDefault();const{x:a,y:c,scaleX:l,scaleY:r}=t(e),d=this.getHitLine(a,c,l,r);d&&(this.isDragging=!0,this.dragMode=d.type,this.dragIndex=d.index)},o=e=>{if(e.cancelable&&e.preventDefault(),!this.isDragging&&!e.touches){const{x:a,y:c,scaleX:l,scaleY:r}=t(e),d=this.getHitLine(a,c,l,r);this.canvas.style.cursor=d?d.type==="v"?"col-resize":"row-resize":"default";return}if(this.isDragging){const{x:a,y:c}=t(e);this.dragMode==="v"?this.vLines[this.dragIndex]=Math.max(0,Math.min(this.canvas.width,a)):this.hLines[this.dragIndex]=Math.max(0,Math.min(this.canvas.height,c)),this.draw()}},n=()=>{this.isDragging=!1,this.dragIndex=-1};this.canvas.addEventListener("mousedown",s),this.canvas.addEventListener("mousemove",o),window.addEventListener("mouseup",n),this.canvas.addEventListener("touchstart",s,{passive:!1}),this.canvas.addEventListener("touchmove",o,{passive:!1}),window.addEventListener("touchend",n)}async executeCut(){const t=[],s=[0,...this.vLines,this.canvas.width].sort((n,e)=>n-e),o=[0,...this.hLines,this.canvas.height].sort((n,e)=>n-e);for(let n=0;n<o.length-1;n++)for(let e=0;e<s.length-1;e++){const a=s[e+1]-s[e],c=o[n+1]-o[n],l=document.createElement("canvas");l.width=a,l.height=c,l.getContext("2d").drawImage(this.image,s[e],o[n],a,c,0,0,a,c),t.push(l.toDataURL("image/png"))}return t}}let m=null,h=[],v=null,f=0,w=null;document.getElementById("file-uploader").addEventListener("change",E);document.getElementById("btn-reset-grid").addEventListener("click",p);document.getElementById("cut-btn").addEventListener("click",I);window.switchTab=function(i){document.querySelectorAll(".section").forEach(t=>t.classList.remove("active")),document.querySelectorAll(".nav-btn").forEach(t=>t.classList.remove("active")),document.getElementById(i).classList.add("active"),i==="tab-crop"&&document.getElementById("btn-tab-crop").classList.add("active"),i==="tab-anime"&&document.getElementById("btn-tab-anime").classList.add("active"),i==="tab-static"&&document.getElementById("btn-tab-static").classList.add("active"),i!=="tab-anime"&&clearInterval(v)};function E(i){const t=i.target.files[0];if(!t)return;const s=new FileReader;s.onload=o=>{const n=new Image;n.onload=()=>{m=new L("crop-canvas",n),p()},n.src=o.target.result},s.readAsDataURL(t)}function p(){if(!m)return;const i=parseInt(document.getElementById("cols").value)||4,t=parseInt(document.getElementById("rows").value)||5;m.resetGrid(i,t)}async function I(){if(!m)return alert("請先上傳圖片");window.showLoading("切割 + 魔術棒去背處理中..."),await new Promise(i=>setTimeout(i,100));try{const i=await m.executeCut();h=[];for(let t=0;t<i.length;t++){const s=await b(i[t]);h.push(s)}window.updateStaticWall(),window.switchTab("tab-anime"),window.startPlay()}catch(i){console.error(i),alert("處理失敗: "+i)}finally{window.hideLoading()}}async function b(i){return new Promise(t=>{const s=new Image;s.onload=()=>{const o=s.width,n=s.height,e=document.createElement("canvas");e.width=o,e.height=n;const a=e.getContext("2d");a.drawImage(s,0,0),x(a,o,n);const c=B(e);t(c)},s.src=i})}function x(i,t,s){const o=i.getImageData(0,0,t,s),n=o.data,e=new Uint8Array(t*s),a=[],c=[[0,0],[t-1,0],[0,s-1],[t-1,s-1]];for(let r=0;r<t;r+=5)c.push([r,0]);for(let r=0;r<s;r+=5)c.push([0,r]);c.forEach(r=>a.push(r));function l(r,d,g){if(r>240&&d>240&&g>240)return!0;const u=Math.abs(r-d)<15&&Math.abs(d-g)<15&&Math.abs(r-g)<15,y=r>180&&r<240;return u&&y}for(;a.length>0;){const[r,d]=a.pop(),g=d*t+r;if(r<0||r>=t||d<0||d>=s||e[g])continue;e[g]=1;const u=g*4;l(n[u],n[u+1],n[u+2])&&(n[u+3]=0,a.push([r+1,d],[r-1,d],[r,d+1],[r,d-1]))}i.putImageData(o,0,0)}function B(i){const t=i.width,s=i.height,o=document.createElement("canvas");o.width=t,o.height=s;const n=o.getContext("2d");return n.shadowColor="white",n.shadowBlur=4,n.drawImage(i,0,0),n.drawImage(i,0,0),n.shadowBlur=0,n.drawImage(i,0,0),o.toDataURL()}window.showLoading=i=>{document.getElementById("loading-text").innerText=i,document.getElementById("loading-overlay").style.display="flex"};window.hideLoading=()=>{document.getElementById("loading-overlay").style.display="none"};window.createAPNG=async function(){if(h.length===0)return alert("沒有圖片");window.showLoading("生成 APNG 中..."),await new Promise(i=>setTimeout(i,100));try{const t=1e3/document.getElementById("fps").value,s=[],o=new Image;await new Promise(d=>{o.onload=d,o.src=h[0]});const n=o.width,e=o.height,a=document.createElement("canvas");a.width=n,a.height=e;const c=a.getContext("2d");for(let d=0;d<h.length;d++)await new Promise(g=>{const u=new Image;u.onload=()=>{c.clearRect(0,0,n,e),c.drawImage(u,0,0),s.push(c.getImageData(0,0,n,e).data.buffer),g()},u.src=h[d]});const l=UPNG.encode(s,n,e,0,new Array(h.length).fill(t));w=new Blob([l],{type:"image/png"});const r=URL.createObjectURL(w);document.getElementById("result-img").src=r,document.getElementById("result-area").style.display="block",document.getElementById("result-area").scrollIntoView({behavior:"smooth"})}catch(i){alert("生成失敗: "+i),console.error(i)}finally{window.hideLoading()}};window.downloadResultBlob=function(){if(!w)return;const i=document.createElement("a");i.download="sticker_animation.png",i.href=URL.createObjectURL(w),i.click()};window.loadAnimeFiles=function(i){h=[];let t=0;Array.from(i).forEach((s,o)=>{const n=new FileReader;n.onload=e=>{h[o]=e.target.result,t++,t===i.length&&window.startPlay()},n.readAsDataURL(s)}),window.switchTab("tab-anime")};window.startPlay=function(){if(clearInterval(v),h.length===0)return;document.getElementById("status-text").innerText="準備就緒";const i=document.getElementById("fps").value;v=setInterval(()=>{document.getElementById("anime-screen").src=h[f],f=(f+1)%h.length},1e3/i)};window.updateFPS=function(){document.getElementById("fps-val").innerText=document.getElementById("fps").value,window.startPlay()};window.updateStaticWall=function(){const i=document.getElementById("preview-wall");i.innerHTML="",h.forEach(t=>{const s=document.createElement("div");s.className="thumb",s.innerHTML=`<img src="${t}">`,i.appendChild(s)})};window.downloadZip=function(){const i=new JSZip;h.forEach((t,s)=>i.file(`${s+1}.png`,t.split(",")[1],{base64:!0})),i.generateAsync({type:"blob"}).then(t=>{const s=document.createElement("a");s.download="frames.zip",s.href=URL.createObjectURL(t),s.click()})};
