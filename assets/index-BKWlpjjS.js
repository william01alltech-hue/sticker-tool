(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const e of n)if(e.type==="childList")for(const o of e.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function i(n){const e={};return n.integrity&&(e.integrity=n.integrity),n.referrerPolicy&&(e.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?e.credentials="include":n.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function a(n){if(n.ep)return;n.ep=!0;const e=i(n);fetch(n.href,e)}})();class L{constructor(t,i){this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.image=i,this.cols=4,this.rows=2,this.vLines=[],this.hLines=[],this.dragMode=null,this.dragIndex=-1,this.isDragging=!1,this.lineTolerance=20,this.initCanvas(),this.resetGrid(this.cols,this.rows),this.addEventListeners()}initCanvas(){this.canvas.width=this.image.width,this.canvas.height=this.image.height,this.draw()}resetGrid(t,i){this.vLines=[],this.hLines=[];const a=this.canvas.width/t,n=this.canvas.height/i;for(let e=1;e<t;e++)this.vLines.push(e*a);for(let e=1;e<i;e++)this.hLines.push(e*n);this.draw()}draw(){const{ctx:t,canvas:i,image:a,vLines:n,hLines:e}=this;t.clearRect(0,0,i.width,i.height),t.drawImage(a,0,0),t.fillStyle="rgba(0, 0, 0, 0.3)",t.fillRect(0,0,i.width,i.height),t.beginPath(),t.strokeStyle="#00FF00",t.lineWidth=4,n.forEach(o=>{t.moveTo(o,0),t.lineTo(o,i.height)}),e.forEach(o=>{t.moveTo(0,o),t.lineTo(i.width,o)}),t.stroke()}getHitLine(t,i){for(let a=0;a<this.vLines.length;a++)if(Math.abs(t-this.vLines[a])<this.lineTolerance)return{type:"v",index:a};for(let a=0;a<this.hLines.length;a++)if(Math.abs(i-this.hLines[a])<this.lineTolerance)return{type:"h",index:a};return null}addEventListeners(){const t=e=>{const o=this.canvas.getBoundingClientRect(),r=e.touches?e.touches[0].clientX:e.clientX,l=e.touches?e.touches[0].clientY:e.clientY,c=this.canvas.width/o.width,d=this.canvas.height/o.height;return{x:(r-o.left)*c,y:(l-o.top)*d}},i=e=>{e.cancelable&&e.preventDefault();const{x:o,y:r}=t(e),l=this.getHitLine(o,r);l&&(this.isDragging=!0,this.dragMode=l.type,this.dragIndex=l.index)},a=e=>{e.cancelable&&e.preventDefault();const{x:o,y:r}=t(e);if(this.isDragging)this.dragMode==="v"?this.vLines[this.dragIndex]=Math.max(0,Math.min(this.canvas.width,o)):this.hLines[this.dragIndex]=Math.max(0,Math.min(this.canvas.height,r)),this.draw();else{const l=this.getHitLine(o,r);this.canvas.style.cursor=l?l.type==="v"?"col-resize":"row-resize":"default"}},n=()=>{this.isDragging=!1,this.dragIndex=-1};this.canvas.addEventListener("mousedown",i),this.canvas.addEventListener("mousemove",a),window.addEventListener("mouseup",n),this.canvas.addEventListener("touchstart",i,{passive:!1}),this.canvas.addEventListener("touchmove",a,{passive:!1}),window.addEventListener("touchend",n)}async executeCut(){const t=[],i=[0,...this.vLines,this.canvas.width].sort((n,e)=>n-e),a=[0,...this.hLines,this.canvas.height].sort((n,e)=>n-e);for(let n=0;n<a.length-1;n++)for(let e=0;e<i.length-1;e++){const o=i[e+1]-i[e],r=a[n+1]-a[n],l=document.createElement("canvas");l.width=o,l.height=r,l.getContext("2d").drawImage(this.image,i[e],a[n],o,r,0,0,o,r),t.push(l.toDataURL("image/png"))}return t}}let m=null,h=[],v=null,f=0,w=null;document.getElementById("file-uploader").addEventListener("change",E);document.getElementById("btn-reset-grid").addEventListener("click",p);document.getElementById("cut-btn").addEventListener("click",I);window.switchTab=function(s){document.querySelectorAll(".section").forEach(t=>t.classList.remove("active")),document.querySelectorAll(".nav-btn").forEach(t=>t.classList.remove("active")),document.getElementById(s).classList.add("active"),s==="tab-crop"&&document.getElementById("btn-tab-crop").classList.add("active"),s==="tab-anime"&&document.getElementById("btn-tab-anime").classList.add("active"),s==="tab-static"&&document.getElementById("btn-tab-static").classList.add("active"),s!=="tab-anime"&&clearInterval(v)};function E(s){const t=s.target.files[0];if(!t)return;const i=new FileReader;i.onload=a=>{const n=new Image;n.onload=()=>{m=new L("crop-canvas",n),p()},n.src=a.target.result},i.readAsDataURL(t)}function p(){if(!m)return;const s=parseInt(document.getElementById("cols").value)||4,t=parseInt(document.getElementById("rows").value)||5;m.resetGrid(s,t)}async function I(){if(!m)return alert("請先上傳圖片");window.showLoading("切割 + 魔術棒去背處理中..."),await new Promise(s=>setTimeout(s,100));try{const s=await m.executeCut();h=[];for(let t=0;t<s.length;t++){const i=await b(s[t]);h.push(i)}window.updateStaticWall(),window.switchTab("tab-anime"),window.startPlay()}catch(s){console.error(s),alert("處理失敗: "+s)}finally{window.hideLoading()}}async function b(s){return new Promise(t=>{const i=new Image;i.onload=()=>{const a=i.width,n=i.height,e=document.createElement("canvas");e.width=a,e.height=n;const o=e.getContext("2d");o.drawImage(i,0,0),x(o,a,n);const r=B(e);t(r)},i.src=s})}function x(s,t,i){const a=s.getImageData(0,0,t,i),n=a.data,e=new Uint8Array(t*i),o=[],r=[[0,0],[t-1,0],[0,i-1],[t-1,i-1]];for(let c=0;c<t;c+=5)r.push([c,0]);for(let c=0;c<i;c+=5)r.push([0,c]);r.forEach(c=>o.push(c));function l(c,d,g){if(c>240&&d>240&&g>240)return!0;const u=Math.abs(c-d)<15&&Math.abs(d-g)<15&&Math.abs(c-g)<15,y=c>180&&c<240;return u&&y}for(;o.length>0;){const[c,d]=o.pop(),g=d*t+c;if(c<0||c>=t||d<0||d>=i||e[g])continue;e[g]=1;const u=g*4;l(n[u],n[u+1],n[u+2])&&(n[u+3]=0,o.push([c+1,d],[c-1,d],[c,d+1],[c,d-1]))}s.putImageData(a,0,0)}function B(s){const t=s.width,i=s.height,a=document.createElement("canvas");a.width=t,a.height=i;const n=a.getContext("2d");return n.shadowColor="white",n.shadowBlur=4,n.drawImage(s,0,0),n.drawImage(s,0,0),n.shadowBlur=0,n.drawImage(s,0,0),a.toDataURL()}window.showLoading=s=>{document.getElementById("loading-text").innerText=s,document.getElementById("loading-overlay").style.display="flex"};window.hideLoading=()=>{document.getElementById("loading-overlay").style.display="none"};window.createAPNG=async function(){if(h.length===0)return alert("沒有圖片");window.showLoading("生成 APNG 中..."),await new Promise(s=>setTimeout(s,100));try{const t=1e3/document.getElementById("fps").value,i=[],a=new Image;await new Promise(d=>{a.onload=d,a.src=h[0]});const n=a.width,e=a.height,o=document.createElement("canvas");o.width=n,o.height=e;const r=o.getContext("2d");for(let d=0;d<h.length;d++)await new Promise(g=>{const u=new Image;u.onload=()=>{r.clearRect(0,0,n,e),r.drawImage(u,0,0),i.push(r.getImageData(0,0,n,e).data.buffer),g()},u.src=h[d]});const l=UPNG.encode(i,n,e,0,new Array(h.length).fill(t));w=new Blob([l],{type:"image/png"});const c=URL.createObjectURL(w);document.getElementById("result-img").src=c,document.getElementById("result-area").style.display="block",document.getElementById("result-area").scrollIntoView({behavior:"smooth"})}catch(s){alert("生成失敗: "+s),console.error(s)}finally{window.hideLoading()}};window.downloadResultBlob=function(){if(!w)return;const s=document.createElement("a");s.download="sticker_animation.png",s.href=URL.createObjectURL(w),s.click()};window.loadAnimeFiles=function(s){h=[];let t=0;Array.from(s).forEach((i,a)=>{const n=new FileReader;n.onload=e=>{h[a]=e.target.result,t++,t===s.length&&window.startPlay()},n.readAsDataURL(i)}),window.switchTab("tab-anime")};window.startPlay=function(){if(clearInterval(v),h.length===0)return;document.getElementById("status-text").innerText="準備就緒";const s=document.getElementById("fps").value;v=setInterval(()=>{document.getElementById("anime-screen").src=h[f],f=(f+1)%h.length},1e3/s)};window.updateFPS=function(){document.getElementById("fps-val").innerText=document.getElementById("fps").value,window.startPlay()};window.updateStaticWall=function(){const s=document.getElementById("preview-wall");s.innerHTML="",h.forEach(t=>{const i=document.createElement("div");i.className="thumb",i.innerHTML=`<img src="${t}">`,s.appendChild(i)})};window.downloadZip=function(){const s=new JSZip;h.forEach((t,i)=>s.file(`${i+1}.png`,t.split(",")[1],{base64:!0})),s.generateAsync({type:"blob"}).then(t=>{const i=document.createElement("a");i.download="frames.zip",i.href=URL.createObjectURL(t),i.click()})};
